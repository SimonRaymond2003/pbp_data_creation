---
title: "pbp_data_creation2"
output: html_document
date: "2024-12-04"
---
Previous Season and Current Season Statistics To-Do List:


Formation Tendencies


Previous season rates for: shotgun, singleback, empty, iform, pistol, wildcat, jumbo
Previous season success rates for each formation


Defensive Statistics


Previous season stop rates: overall, run, pass
Previous season down-specific stop rates (1st-4th down)


Coverage Statistics


Previous season stop rates: overall, run, pass per coverage type
Previous season usage rates for each coverage type (cover0-6, 2man, prevent)


Coach Performance


Previous season team win percentage
Previous season overall win percentage


Run/Pass Tendencies


Previous season run percentages for downs 1-4
Previous season 4th down run percentage (of actual attempts only - where play_type is either pass or run)



Team Performance


Previous season total wins
Previous season win percentage
Previous season home/away win percentage


there where changes to 2/7 2.5 2.87/7 and 6



Team Stability/Turnover (New)


Previous season roster turnover rate calculation

Track players present at start vs end of season
Calculate percentage of roster changed
Account for practice squad promotions
Factor in mid-season acquisitions


Current season cumulative roster changes
---
title: "pbp_data_creation"
output: html_document
date: "2024-12-04"
---



```{r}
# Load required libraries
library(dplyr)
library(nflverse)
library(tidyr)
library(purrr)
library(zoo)
library(car)
library(progress)

# Validation function
validate_data <- function(df) {
  dupes <- duplicated(names(df))
  if(any(dupes)) {
    warning("Duplicate columns found: ", paste(names(df)[dupes], collapse=", "))
  }
  
  req_cols <- c("play_id", "game_id", "posteam")
  missing <- req_cols[!req_cols %in% names(df)]
  if(length(missing) > 0) {
    stop("Missing required columns: ", paste(missing, collapse=", "))
  }
  return(df)
}

# Get specialists function
get_specialists <- function(year) {
  pbp <- bind_rows(
    load_pbp(year),
    load_pbp(year - 1)
  ) %>%
  arrange(game_date, desc(play_id))
  
  kickers <- pbp %>%
    filter(field_goal_attempt == 1 | extra_point_attempt == 1) %>%
    select(team = posteam, week, season, kicker_player_id, kicker_player_name) %>%
    distinct(team, week, season, .keep_all = TRUE)
    
  punters <- pbp %>%
    filter(punt_attempt == 1) %>%
    select(team = posteam, week, season, punter_player_id, punter_player_name) %>%
    distinct(team, week, season, .keep_all = TRUE)
    
  list(kickers = kickers, punters = punters)
}
add_player_info <- function(df, players_data, player_col, prefix) {
    if (!player_col %in% names(df)) {
        return(df)
    }
    
    new_cols <- c("full_name", "birth_date", "rookie_year", "draft_number", "jersey_number", "pff_id", 
                "weight", "height", "position", "depth_chart_position")
    
    for(col in new_cols) {
        new_col_name <- paste0(prefix, "_", col)
        df[[new_col_name]] <- NA
    }
    
    df[[paste0(prefix, "_days_since_injury")]] <- NA
    df[[paste0(prefix, "_last_injury_type")]] <- NA
    df[[paste0(prefix, "_injury_count_1yr")]] <- NA
    
    df[[paste0(prefix, "_week_questionable")]] <- 0
    df[[paste0(prefix, "_week_doubtful")]] <- 0
    df[[paste0(prefix, "_week_out")]] <- 0
    df[[paste0(prefix, "_week_limited_practice")]] <- 0
    df[[paste0(prefix, "_week_dnp")]] <- 0
    df[[paste0(prefix, "_current_status")]] <- NA
    df[[paste0(prefix, "_current_practice")]] <- NA
    
    valid_players <- unique(df[[player_col]][!is.na(df[[player_col]])])
    
    if(length(valid_players) > 0) {
        players_info <- players_data %>%
            filter(gsis_id %in% valid_players) %>%
            group_by(gsis_id) %>%
            slice_tail(n = 1) %>%
            ungroup() %>%
            select(gsis_id, all_of(new_cols))
        
        for(i in 1:nrow(df)) {
            if(!is.na(df[[player_col]][i])) {
                player_id <- df[[player_col]][i]
                current_date <- as.Date(df$game_date[i])
                player_data <- players_info %>% filter(gsis_id == player_id)
                
                if(nrow(player_data) == 1) {
                    for(col in new_cols) {
                        if(!is.null(player_data[[col]])) {
                            df[i, paste0(prefix, "_", col)] <- player_data[[col]][1]
                        }
                    }
                }
                
                player_injuries <- injuries_data %>%
                    filter(gsis_id == player_id,
                           injury_date < current_date,
                           !is.na(injury_date)) %>%
                    arrange(desc(injury_date))
                
                if(nrow(player_injuries) > 0) {
                    df[i, paste0(prefix, "_days_since_injury")] <- 
                        as.numeric(difftime(current_date, player_injuries$injury_date[1], units = "days"))
                    
                    df[i, paste0(prefix, "_last_injury_type")] <- 
                        player_injuries$practice_primary_injury[1]
                    
                    one_year_ago <- current_date - 365
                    df[i, paste0(prefix, "_injury_count_1yr")] <- 
                        sum(player_injuries$injury_date >= one_year_ago)
                    
                    week_ago <- current_date - 7
                    recent_injuries <- injuries_data %>%
                        filter(gsis_id == player_id,
                               injury_date >= week_ago,
                               injury_date < current_date)
                    
                    if(nrow(recent_injuries) > 0) {
                        df[i, paste0(prefix, "_week_questionable")] <- 
                            sum(recent_injuries$report_status == "Questionable", na.rm = TRUE)
                        df[i, paste0(prefix, "_week_doubtful")] <- 
                            sum(recent_injuries$report_status == "Doubtful", na.rm = TRUE)
                        df[i, paste0(prefix, "_week_out")] <- 
                            sum(recent_injuries$report_status == "Out", na.rm = TRUE)
                        df[i, paste0(prefix, "_week_limited_practice")] <- 
                            sum(recent_injuries$practice_status == "Limited Participation in Practice", na.rm = TRUE)
                        df[i, paste0(prefix, "_week_dnp")] <- 
                            sum(recent_injuries$practice_status == "Did Not Participate In Practice", na.rm = TRUE)
                        
                        df[i, paste0(prefix, "_current_status")] <- recent_injuries$report_status[1]
                        df[i, paste0(prefix, "_current_practice")] <- recent_injuries$practice_status[1]
                    }
                }
            }
        }
    }
    return(df)
}
```




```{r}
process_year <- function(year) {
 message(paste("\nProcessing year:", year))
  
  message("Step 1/7: Loading data...")
  # Add global assignment
  injuries_data <<- load_injuries((year-2):year) %>%
    mutate(injury_date = as.Date(date_modified))

  top_injury_types <- injuries_data %>%
    filter(!is.na(practice_primary_injury)) %>%
    count(practice_primary_injury, sort = TRUE) %>%
    slice_head(n = 9) %>%
    pull(practice_primary_injury)

  get_team_injury_counts <- function(team, game_date) {
    game_date <- as.Date(game_date)
    
    team_injuries <- injuries_data %>%
      filter(team == !!team) %>%
      mutate(
        injury_date = as.Date(date_modified),
        standard_injury = case_when(
          practice_primary_injury %in% top_injury_types ~ practice_primary_injury,
          TRUE ~ "Other"
        )
      )
    
    year_ago <- game_date - 365
    year_injuries <- team_injuries %>%
      filter(injury_date >= year_ago,
             injury_date < game_date) %>%
      count(standard_injury) %>%
      pivot_wider(
        names_from = standard_injury,
        names_prefix = "injury_count_year_",
        values_from = n,
        values_fill = 0
      )
    
    week_ago <- game_date - 7
    week_injuries <- team_injuries %>%
      filter(injury_date >= week_ago,
             injury_date < game_date) %>%
      count(standard_injury) %>%
      pivot_wider(
        names_from = standard_injury,
        names_prefix = "injury_count_week_",
        values_from = n,
        values_fill = 0
      )
      
    week_status <- team_injuries %>%
      filter(injury_date >= week_ago,
             injury_date < game_date) %>%
      summarise(
        week_questionable = sum(report_status == "Questionable", na.rm = TRUE),
        week_doubtful = sum(report_status == "Doubtful", na.rm = TRUE),
        week_out = sum(report_status == "Out", na.rm = TRUE),
        week_limited_practice = sum(practice_status == "Limited Participation in Practice", na.rm = TRUE),
        week_dnp = sum(practice_status == "Did Not Participate In Practice", na.rm = TRUE)
      )
    
    bind_cols(year_injuries, week_injuries, week_status)
  }

  play_year <- load_pbp(year)
  participation_data <- load_participation(year) %>%
    select(
      nflverse_game_id,
      play_id,
      offense_formation,
      offense_personnel,
      defense_personnel,
      defenders_in_box,
      number_of_pass_rushers,
      offense_players,
      defense_players,
      defense_man_zone_type,
      defense_coverage_type
    )
    
  roster_data <- load_rosters(year)
    
  message("Step 2/7: Processing weekly stats...")
  weekly_run_stats <- play_year %>%
    filter(play_type %in% c("pass", "run"), down %in% 1:3) %>%
    group_by(posteam, week, down) %>%
    summarize(
      weekly_run_plays = sum(play_type == "run", na.rm = TRUE),
      weekly_total_plays = n(),
      .groups = 'drop'
    ) %>%
    arrange(posteam, week, down) %>%
    group_by(posteam, down) %>%
    mutate(
      cum_run_plays = cumsum(weekly_run_plays),
      cum_total_plays = cumsum(weekly_total_plays)
    ) %>%
    ungroup() %>%
    pivot_wider(
      id_cols = c(posteam, week),
      names_from = down,
      names_glue = "down{down}_{.value}",
      values_from = c(cum_run_plays, cum_total_plays)
    ) %>%
    arrange(posteam, week)

  run_pcts <- weekly_run_stats %>%
    mutate(
      down1_pct = round(100 * down1_cum_run_plays / down1_cum_total_plays, 1),
      down2_pct = round(100 * down2_cum_run_plays / down2_cum_total_plays, 1),
      down3_pct = round(100 * down3_cum_run_plays / down3_cum_total_plays, 1)
    ) %>%
    select(posteam, week, down1_pct, down2_pct, down3_pct)

  prep_time_df <- play_year %>%
    select(game_id, game_date, posteam = home_team) %>%
    distinct() %>%
    bind_rows(
      play_year %>%
        select(game_id, game_date, posteam = away_team) %>%
        distinct()
    ) %>%
    arrange(posteam, game_date) %>%
    group_by(posteam) %>%
    mutate(
      last_game_date = lag(game_date),
      prep_days = as.numeric(difftime(game_date, last_game_date, units = "days"))
    ) %>%
    ungroup()

  # Add after run_pcts but before prep_time_df in Step 2/7:
  message("Step 2.5/7: Processing coach history...")
  
  # Get coach records across all games
  coach_records <- play_year %>%
    select(game_id, game_date, home_team, away_team, home_coach, away_coach,
           home_score, away_score) %>%
    distinct() %>%
    # Get home coach records
    mutate(
      home_win = home_score > away_score,
      home_loss = home_score < away_score
    ) %>%
    group_by(home_coach) %>%
    summarize(
      overall_wins = sum(home_win, na.rm = TRUE),
      overall_losses = sum(home_loss, na.rm = TRUE),
      overall_win_pct = round(sum(home_win, na.rm = TRUE) / n(), 3)
    ) %>%
    # Combine with away coach records
    bind_rows(
      play_year %>%
      select(game_id, away_coach, home_score, away_score) %>%
      distinct() %>%
      group_by(away_coach) %>%
      summarize(
        overall_wins = sum(away_score > home_score, na.rm = TRUE),
        overall_losses = sum(away_score < home_score, na.rm = TRUE),
        overall_win_pct = round(sum(away_score > home_score, na.rm = TRUE) / n(), 3)
      )
    ) %>%
    group_by(home_coach) %>%
    summarize(
      overall_wins = sum(overall_wins),
      overall_losses = sum(overall_losses),
      overall_win_pct = round(mean(overall_win_pct), 3)
    ) %>%
    rename(coach = home_coach)

  # Get coach records with current team only
  current_team_records <- play_year %>%
    select(game_id, game_date, posteam, home_team, away_team, home_coach, away_coach,
           posteam_score, defteam_score) %>%
    distinct() %>%
    mutate(
      coach = ifelse(posteam == home_team, home_coach, away_coach)
    ) %>%
    group_by(coach, posteam) %>%
    summarize(
      team_wins = sum(posteam_score > defteam_score, na.rm = TRUE),
      team_losses = sum(posteam_score < defteam_score, na.rm = TRUE),
      team_win_pct = round(mean(posteam_score > defteam_score, na.rm = TRUE), 3),
      .groups = 'drop'
    )
  
  # Add after coach records calculation in Step 2.5:
message("Diagnosing coach records duplicates...")
coach_dupes <- coach_records %>%
  group_by(coach) %>%
  filter(n() > 1)

print("Number of duplicate coach record rows:")
print(nrow(coach_dupes))
if(nrow(coach_dupes) > 0) {
  print("Sample of duplicates:")
  print(head(coach_dupes))
}
  
 message("Step 2.6/7: Processing coach tenure...")
# Calculate coach tenure - modify this section
coach_tenure <- play_year %>%
    select(game_date, home_team, away_team, home_coach, away_coach) %>%
    # Get unique games first
    distinct() %>%
    pivot_longer(
      cols = c(home_coach, away_coach),
      names_to = "role",
      values_to = "coach"
    ) %>%
    mutate(team = if_else(role == "home_coach", home_team, away_team)) %>%
    # Get first appearance for each coach-team combo
    group_by(coach, team) %>%
    summarize(
      first_appearance = min(game_date),
      .groups = 'drop'
    )

# Calculate tenure for each game - modify this section
game_tenure <- play_year %>%
    select(game_id, game_date, posteam, home_team, away_team, home_coach, away_coach) %>%
    # Get unique game-team combinations
    distinct() %>%
    mutate(
      coach = ifelse(posteam == home_team, home_coach, away_coach)
    ) %>%
    left_join(coach_tenure, by = c("coach", "posteam" = "team")) %>%
    mutate(
      tenure_days = as.numeric(as.Date(game_date) - as.Date(first_appearance))
    )
  
  # Add after game tenure calculation in Step 2.6:
message("Diagnosing game tenure duplicates...")
tenure_dupes <- game_tenure %>%
  group_by(game_id, posteam, coach) %>%
  filter(n() > 1)

print("Number of duplicate tenure rows:")
print(nrow(tenure_dupes))
if(nrow(tenure_dupes) > 0) {
  print("Sample of duplicates:")
  print(head(tenure_dupes))
}

# Add after the game tenure diagnostic check:
if(nrow(tenure_dupes) > 0) {
    print("Detailed look at tenure duplicates:")
    print(
        tenure_dupes %>%
        arrange(game_id, posteam, coach) %>%
        select(game_id, game_date, posteam, coach, first_appearance, tenure_days) %>%
        head(10)
    )
    
    # Count frequency of duplications
    print("Number of duplicates per game/team/coach combination:")
    print(
        tenure_dupes %>%
        group_by(game_id, posteam, coach) %>%
        summarise(n = n(), .groups = 'drop') %>%
        count(n) %>%
        arrange(desc(n))
    )
}


  
message("Step 2.7/7: Processing formation, defensive tendencies, and coverage rates...")

# Formation tendencies by down with rolling calculations
message("  Processing formation tendencies...")
formation_tendencies <- play_year %>%
  left_join(participation_data, by = c("game_id" = "nflverse_game_id", "play_id")) %>%
  filter(play_type %in% c("pass", "run")) %>%
  arrange(posteam, week) %>%
  group_by(posteam, week, down) %>%
  summarize(
    weekly_formation_plays = sum(!is.na(offense_formation)),
    weekly_shotgun = sum(offense_formation == "SHOTGUN", na.rm = TRUE),
    weekly_singleback = sum(offense_formation == "SINGLEBACK", na.rm = TRUE),
    weekly_empty = sum(offense_formation == "EMPTY", na.rm = TRUE),
    weekly_iform = sum(offense_formation == "I_FORM", na.rm = TRUE),
    weekly_pistol = sum(offense_formation == "PISTOL", na.rm = TRUE),
    weekly_wildcat = sum(offense_formation == "WILDCAT", na.rm = TRUE),
    weekly_jumbo = sum(offense_formation == "JUMBO", na.rm = TRUE),
    
    # Weekly success counts
    weekly_shotgun_success = sum(first_down[offense_formation == "SHOTGUN"], na.rm = TRUE),
    weekly_singleback_success = sum(first_down[offense_formation == "SINGLEBACK"], na.rm = TRUE),
    weekly_empty_success = sum(first_down[offense_formation == "EMPTY"], na.rm = TRUE),
    weekly_iform_success = sum(first_down[offense_formation == "I_FORM"], na.rm = TRUE),
    weekly_pistol_success = sum(first_down[offense_formation == "PISTOL"], na.rm = TRUE),
    weekly_wildcat_success = sum(first_down[offense_formation == "WILDCAT"], na.rm = TRUE),
    weekly_jumbo_success = sum(first_down[offense_formation == "JUMBO"], na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  group_by(posteam, down) %>%
  arrange(week) %>%
  mutate(across(starts_with("weekly_"), ~replace_na(., 0))) %>%
  mutate(
    # Cumulative totals
    total_formation_plays = cumsum(weekly_formation_plays),
    
    # Formation usage rates (rolling)
    shotgun_rate = cumsum(weekly_shotgun) / total_formation_plays,
    singleback_rate = cumsum(weekly_singleback) / total_formation_plays,
    empty_rate = cumsum(weekly_empty) / total_formation_plays,
    iform_rate = cumsum(weekly_iform) / total_formation_plays,
    pistol_rate = cumsum(weekly_pistol) / total_formation_plays,
    wildcat_rate = cumsum(weekly_wildcat) / total_formation_plays,
    jumbo_rate = cumsum(weekly_jumbo) / total_formation_plays,
    
    # Success rates (rolling)
    shotgun_success = cumsum(weekly_shotgun_success) / cumsum(weekly_shotgun),
    singleback_success = cumsum(weekly_singleback_success) / cumsum(weekly_singleback),
    empty_success = cumsum(weekly_empty_success) / cumsum(weekly_empty),
    iform_success = cumsum(weekly_iform_success) / cumsum(weekly_iform),
    pistol_success = cumsum(weekly_pistol_success) / cumsum(weekly_pistol),
    wildcat_success = cumsum(weekly_wildcat_success) / cumsum(weekly_wildcat),
    jumbo_success = cumsum(weekly_jumbo_success) / cumsum(weekly_jumbo)
  ) %>%
  ungroup()

# Print diagnostic info for formation tendencies
message("Formation tendencies summary:")
print(summary(formation_tendencies))
message(paste("Number of NA values in formation rates:", 
             sum(is.na(formation_tendencies$shotgun_rate))))

# Defense tendencies with down-specific stats
message("  Processing defensive tendencies and stop rates...")
defense_tendencies <- play_year %>%
  left_join(participation_data, by = c("game_id" = "nflverse_game_id", "play_id")) %>%
  filter(play_type %in% c("pass", "run")) %>%
  arrange(defteam, week) %>%
  group_by(defteam, week) %>%
  summarize(
    # Overall stats
    weekly_plays = n(),
    weekly_run_plays = sum(play_type == "run", na.rm = TRUE),
    weekly_pass_plays = sum(play_type == "pass", na.rm = TRUE),
    weekly_run_stops = sum(play_type == "run" & !first_down, na.rm = TRUE),
    weekly_pass_stops = sum(play_type == "pass" & !first_down, na.rm = TRUE),
    weekly_total_stops = sum(!first_down, na.rm = TRUE),
    
    # First down stats
    weekly_1st_run_plays = sum(play_type == "run" & down == 1, na.rm = TRUE),
    weekly_1st_pass_plays = sum(play_type == "pass" & down == 1, na.rm = TRUE),
    weekly_1st_run_stops = sum(play_type == "run" & down == 1 & !first_down, na.rm = TRUE),
    weekly_1st_pass_stops = sum(play_type == "pass" & down == 1 & !first_down, na.rm = TRUE),
    
    # Second down stats
    weekly_2nd_run_plays = sum(play_type == "run" & down == 2, na.rm = TRUE),
    weekly_2nd_pass_plays = sum(play_type == "pass" & down == 2, na.rm = TRUE),
    weekly_2nd_run_stops = sum(play_type == "run" & down == 2 & !first_down, na.rm = TRUE),
    weekly_2nd_pass_stops = sum(play_type == "pass" & down == 2 & !first_down, na.rm = TRUE),
    
    # Third down stats
    weekly_3rd_run_plays = sum(play_type == "run" & down == 3, na.rm = TRUE),
    weekly_3rd_pass_plays = sum(play_type == "pass" & down == 3, na.rm = TRUE),
    weekly_3rd_run_stops = sum(play_type == "run" & down == 3 & !first_down, na.rm = TRUE),
    weekly_3rd_pass_stops = sum(play_type == "pass" & down == 3 & !first_down, na.rm = TRUE),
    
    # Fourth down stats
    weekly_4th_run_plays = sum(play_type == "run" & down == 4, na.rm = TRUE),
    weekly_4th_pass_plays = sum(play_type == "pass" & down == 4, na.rm = TRUE),
    weekly_4th_run_stops = sum(play_type == "run" & down == 4 & !first_down, na.rm = TRUE),
    weekly_4th_pass_stops = sum(play_type == "pass" & down == 4 & !first_down, na.rm = TRUE),
    
    weekly_pass_rushers = mean(number_of_pass_rushers, na.rm = TRUE),
    weekly_box_defenders = mean(defenders_in_box, na.rm = TRUE),
    
    # Coverage type counts
    weekly_cover0 = sum(defense_coverage_type == "COVER_0", na.rm = TRUE),
    weekly_cover1 = sum(defense_coverage_type == "COVER_1", na.rm = TRUE),
    weekly_cover2 = sum(defense_coverage_type == "COVER_2", na.rm = TRUE),
    weekly_cover3 = sum(defense_coverage_type == "COVER_3", na.rm = TRUE),
    weekly_cover4 = sum(defense_coverage_type == "COVER_4", na.rm = TRUE),
    weekly_cover6 = sum(defense_coverage_type == "COVER_6", na.rm = TRUE),
    weekly_two_man = sum(defense_coverage_type == "2_MAN", na.rm = TRUE),
    weekly_prevent = sum(defense_coverage_type == "PREVENT", na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  group_by(defteam) %>%
  arrange(week) %>%
  mutate(
    # Overall cumulative stats
    cum_plays = cumsum(weekly_plays),
    cum_run_plays = cumsum(weekly_run_plays),
    cum_pass_plays = cumsum(weekly_pass_plays),
    cum_run_stops = cumsum(weekly_run_stops),
    cum_pass_stops = cumsum(weekly_pass_stops),
    cum_total_stops = cumsum(weekly_total_stops),
    
    # First down cumulative stats
    cum_1st_run_plays = cumsum(weekly_1st_run_plays),
    cum_1st_pass_plays = cumsum(weekly_1st_pass_plays),
    cum_1st_run_stops = cumsum(weekly_1st_run_stops),
    cum_1st_pass_stops = cumsum(weekly_1st_pass_stops),
    
    # Second down cumulative stats
    cum_2nd_run_plays = cumsum(weekly_2nd_run_plays),
    cum_2nd_pass_plays = cumsum(weekly_2nd_pass_plays),
    cum_2nd_run_stops = cumsum(weekly_2nd_run_stops),
    cum_2nd_pass_stops = cumsum(weekly_2nd_pass_stops),
    
    # Third down cumulative stats
    cum_3rd_run_plays = cumsum(weekly_3rd_run_plays),
    cum_3rd_pass_plays = cumsum(weekly_3rd_pass_plays),
    cum_3rd_run_stops = cumsum(weekly_3rd_run_stops),
    cum_3rd_pass_stops = cumsum(weekly_3rd_pass_stops),
    
    # Fourth down cumulative stats
    cum_4th_run_plays = cumsum(weekly_4th_run_plays),
    cum_4th_pass_plays = cumsum(weekly_4th_pass_plays),
    cum_4th_run_stops = cumsum(weekly_4th_run_stops),
    cum_4th_pass_stops = cumsum(weekly_4th_pass_stops),
    
    # Overall stop rates with minimum play thresholds
    def_stop_rate_run = if_else(cum_run_plays >= 5, 
                               cum_run_stops / cum_run_plays, 
                               NA_real_),
    def_stop_rate_pass = if_else(cum_pass_plays >= 5, 
                                cum_pass_stops / cum_pass_plays, 
                                NA_real_),
    def_stop_rate_total = if_else(cum_plays >= 10, 
                                 cum_total_stops / cum_plays, 
                                 NA_real_),
    
    # First down stop rates
    def_stop_rate_1st_run = if_else(cum_1st_run_plays >= 5,
                                   cum_1st_run_stops / cum_1st_run_plays,
                                   NA_real_),
    def_stop_rate_1st_pass = if_else(cum_1st_pass_plays >= 5,
                                    cum_1st_pass_stops / cum_1st_pass_plays,
                                    NA_real_),
    
    # Second down stop rates
    def_stop_rate_2nd_run = if_else(cum_2nd_run_plays >= 5,
                                   cum_2nd_run_stops / cum_2nd_run_plays,
                                   NA_real_),
    def_stop_rate_2nd_pass = if_else(cum_2nd_pass_plays >= 5,
                                    cum_2nd_pass_stops / cum_2nd_pass_plays,
                                    NA_real_),
    
    # Third down stop rates
    def_stop_rate_3rd_run = if_else(cum_3rd_run_plays >= 5,
                                   cum_3rd_run_stops / cum_3rd_run_plays,
                                   NA_real_),
    def_stop_rate_3rd_pass = if_else(cum_3rd_pass_plays >= 5,
                                    cum_3rd_pass_stops / cum_3rd_pass_plays,
                                    NA_real_),
    
    # Fourth down stop rates
    def_stop_rate_4th_run = if_else(cum_4th_run_plays >= 5,
                                   cum_4th_run_stops / cum_4th_run_plays,
                                   NA_real_),
    def_stop_rate_4th_pass = if_else(cum_4th_pass_plays >= 5,
                                    cum_4th_pass_stops / cum_4th_pass_plays,
                                    NA_real_),
    
    # Rolling averages for continuous metrics
    avg_pass_rushers = cummean(weekly_pass_rushers),
    avg_box_defenders = cummean(weekly_box_defenders),
    
    # Coverage rates
    cover0_rate = cumsum(weekly_cover0) / cum_plays,
    cover1_rate = cumsum(weekly_cover1) / cum_plays,
    cover2_rate = cumsum(weekly_cover2) / cum_plays,
    cover3_rate = cumsum(weekly_cover3) / cum_plays,
    cover4_rate = cumsum(weekly_cover4) / cum_plays,
    cover6_rate = cumsum(weekly_cover6) / cum_plays,
    two_man_rate = cumsum(weekly_two_man) / cum_plays,
    prevent_rate = cumsum(weekly_prevent) / cum_plays
  ) %>%
  ungroup()

# Print diagnostic info for defense tendencies
message("Defense tendencies summary:")
print(summary(defense_tendencies))
message(paste("Number of NA values in stop rates:",
             sum(is.na(defense_tendencies$def_stop_rate_total))))

# Coverage-specific stop rates
message("  Processing coverage-specific stop rates...")
coverage_tendencies <- play_year %>%
  left_join(participation_data, by = c("game_id" = "nflverse_game_id", "play_id")) %>%
  filter(play_type %in% c("pass", "run")) %>%
  arrange(defteam, week) %>%
  group_by(defteam, week, defense_coverage_type, down) %>%
  summarize(
    weekly_plays = n(),
    weekly_stops = sum(!first_down, na.rm = TRUE),
    weekly_run_plays = sum(play_type == "run", na.rm = TRUE),
    weekly_pass_plays = sum(play_type == "pass", na.rm = TRUE),
    weekly_run_stops = sum(play_type == "run" & !first_down, na.rm = TRUE),
    weekly_pass_stops = sum(play_type == "pass" & !first_down, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  group_by(defteam, defense_coverage_type, down) %>%
  arrange(week) %>%
  mutate(across(starts_with("weekly_"), ~replace_na(., 0))) %>%
  mutate(
    cum_plays = cumsum(weekly_plays),
    cum_stops = cumsum(weekly_stops),
    cum_run_plays = cumsum(weekly_run_plays),
    cum_pass_plays = cumsum(weekly_pass_plays),
    cum_run_stops = cumsum(weekly_run_stops),
    cum_pass_stops = cumsum(weekly_pass_stops),
    
    # Calculate stop rates with minimum play thresholds
    coverage_stop_rate = if_else(cum_plays >= 10,
                                cum_stops / cum_plays,
                                NA_real_),
    coverage_stop_rate_run = if_else(cum_run_plays >= 5,
                                    cum_run_stops / cum_run_plays,
                                    NA_real_),
    coverage_stop_rate_pass = if_else(cum_pass_plays >= 5,
                                     cum_pass_stops / cum_pass_plays,
                                     NA_real_)
  ) %>%
  ungroup()

# Print diagnostic info for coverage tendencies
message("\nCoverage tendencies summary:")
print(summary(coverage_tendencies))
message(paste("Number of NA values in coverage stop rates:",
             sum(is.na(coverage_tendencies$coverage_stop_rate))))

message("Step 2.7 completed successfully")

  
message("Step 3/7: Processing third and fourth downs...")
third_downs <- play_year %>%
    filter(down == 3) %>%
    select(
      play_id,
      game_id,
      game_date,
      posteam,
      desc,
      home_team,
      away_team,
      ydstogo,
      yardline_100,
      game_seconds_remaining,
      posteam_timeouts_remaining,
      defteam_timeouts_remaining,
      posteam_score,
      defteam_score,
      play_type,
      yards_gained,
      first_down,
      rush_attempt,
      pass_attempt,
      field_goal_attempt,
      punt_attempt,
      home_coach,
      away_coach,
      week,
      roof,
      temp, 
      wind,
      drive,
      drive_start_transition,
      posteam_type,
      vegas_wp,
      total_line,
      spread_line
    ) %>%
    mutate(
      score_diff = posteam_score - defteam_score,
      posteam_coach = ifelse(posteam == home_team, home_coach, away_coach),
      season = year,
      # Adjust spread_line based on posteam
      spread_line = case_when(
        posteam == home_team ~ spread_line,
        posteam == away_team ~ -1 * spread_line,
        TRUE ~ NA_real_
      )
    ) %>%
    filter(!field_goal_attempt, !punt_attempt, play_type %in% c("pass", "run")) %>%
    mutate(converted = first_down) %>%
    select(-first_down) %>%
    left_join(participation_data, 
              by = c("game_id" = "nflverse_game_id", "play_id" = "play_id"))

fourth_downs <- play_year %>%
    filter(down == 4) %>%
    select(
      play_id,
      game_id,
      game_date,
      posteam,
      desc,
      home_team,
      away_team,
      ydstogo,
      yardline_100,
      game_seconds_remaining,
      posteam_timeouts_remaining,
      defteam_timeouts_remaining,
      posteam_score,
      defteam_score,
      play_type,
      yards_gained,
      first_down,
      rush_attempt,
      pass_attempt,
      field_goal_attempt,
      punt_attempt,
      home_coach,
      away_coach,
      week,
      roof,
      temp, 
      wind,
      drive,
      drive_start_transition,
      posteam_type,
      vegas_wp,
      total_line,
      spread_line
    ) %>%
    mutate(
      score_diff = posteam_score - defteam_score,
      posteam_coach = ifelse(posteam == home_team, home_coach, away_coach),
      attempt = if_else(play_type %in% c("punt", "field_goal"), 0, 1),
      season = year,
      # Adjust spread_line based on posteam
      spread_line = case_when(
        posteam == home_team ~ spread_line,
        posteam == away_team ~ -1 * spread_line,
        TRUE ~ NA_real_
      )
    ) %>%
    left_join(participation_data, 
              by = c("game_id" = "nflverse_game_id", "play_id" = "play_id"))

message("Step 3.1/7: Processing initial Vegas win probabilities...")

# Phase 1: Create a complete lookup table for all teams
initial_wp_lookup <- play_year %>%
  group_by(game_id) %>%
  arrange(game_id, play_id) %>%
  filter(row_number() == 1) %>%
  select(game_id, vegas_wp, home_team, away_team, week) %>%
  # Expand to have a row for each team in the game
  tidyr::pivot_longer(
    cols = c(home_team, away_team),
    names_to = "team_type",
    values_to = "team"
  ) %>%
  mutate(
    vegas_wp_beg = if_else(team_type == "home_team", vegas_wp, 1 - vegas_wp)
  ) %>%
  select(game_id, week, team, vegas_wp_beg)

message(sprintf("Created lookup table with %d team-game combinations", nrow(initial_wp_lookup)))

# Phase 2: Simple joins to third and fourth downs
message("\nProcessing third downs...")
third_downs <- third_downs %>%
  left_join(initial_wp_lookup, by = c("game_id", "week", "posteam" = "team"))

message("\nProcessing fourth downs...")
fourth_downs <- fourth_downs %>%
  left_join(initial_wp_lookup, by = c("game_id", "week", "posteam" = "team"))

# Validation
message("\nValidation:")
message(sprintf("Third downs - NA rate in vegas_wp_beg: %.2f%%", 
               100 * sum(is.na(third_downs$vegas_wp_beg)) / nrow(third_downs)))
message(sprintf("Fourth downs - NA rate in vegas_wp_beg: %.2f%%", 
               100 * sum(is.na(fourth_downs$vegas_wp_beg)) / nrow(fourth_downs)))



message("Step 3.3/7: Processing previous season statistics...")

# Load previous year's data
prev_year <- year - 1
message(sprintf("\nLoading data for previous year: %d", prev_year))

prev_play_year <- load_pbp(prev_year)
prev_participation <- load_participation(prev_year)

# Add early data validation
message("\nDEBUG: Initial data validation")
message("Required columns in prev_play_year:")
req_cols <- c("posteam", "defteam", "play_type", "down", "first_down", 
              "offense_formation", "defense_coverage_type", "game_id")
missing_cols <- req_cols[!req_cols %in% names(prev_play_year)]
if(length(missing_cols) > 0) {
  message("Missing columns: ", paste(missing_cols, collapse=", "))
} else {
  message("All required columns present")
}

# Join participation data
prev_data <- prev_play_year %>%
  left_join(prev_participation, 
            by = c("game_id" = "nflverse_game_id", "play_id")) %>%
  filter(!is.na(posteam))

message("\nDEBUG: Formation Rate Calculation Check")
formation_check <- prev_data %>%
  group_by(posteam) %>%
  summarize(
    total_plays = n(),
    shotgun_plays = sum(offense_formation == "SHOTGUN", na.rm = TRUE),
    shotgun_rate = mean(offense_formation == "SHOTGUN", na.rm = TRUE)
  )
message("Sample formation rates:")
print(head(formation_check))

formation_stats <- prev_data %>%
  filter(play_type %in% c("pass", "run")) %>%
  group_by(posteam) %>%
  summarize(
    prev_total_plays = n(),
    prev_shotgun_rate = mean(offense_formation == "SHOTGUN", na.rm = TRUE),
    prev_singleback_rate = mean(offense_formation == "SINGLEBACK", na.rm = TRUE),
    prev_empty_rate = mean(offense_formation == "EMPTY", na.rm = TRUE),
    prev_iform_rate = mean(offense_formation == "I_FORM", na.rm = TRUE),
    prev_pistol_rate = mean(offense_formation == "PISTOL", na.rm = TRUE),
    prev_wildcat_rate = mean(offense_formation == "WILDCAT", na.rm = TRUE),
    prev_jumbo_rate = mean(offense_formation == "JUMBO", na.rm = TRUE),
    
    # Formation success rates
    prev_shotgun_success = mean(first_down[offense_formation == "SHOTGUN"], na.rm = TRUE),
    prev_singleback_success = mean(first_down[offense_formation == "SINGLEBACK"], na.rm = TRUE),
    prev_empty_success = mean(first_down[offense_formation == "EMPTY"], na.rm = TRUE),
    prev_iform_success = mean(first_down[offense_formation == "I_FORM"], na.rm = TRUE),
    prev_pistol_success = mean(first_down[offense_formation == "PISTOL"], na.rm = TRUE),
    prev_wildcat_success = mean(first_down[offense_formation == "WILDCAT"], na.rm = TRUE),
    prev_jumbo_success = mean(first_down[offense_formation == "JUMBO"], na.rm = TRUE)
  )

message("\nDEBUG: Stop Rate Calculation Check")
stop_check <- prev_data %>%
  filter(!is.na(defteam), play_type %in% c("pass", "run")) %>%
  group_by(defteam) %>%
  summarize(
    total_plays = n(),
    stops = sum(!first_down, na.rm = TRUE),
    stop_rate = mean(!first_down, na.rm = TRUE)
  )
message("Sample stop rates:")
print(head(stop_check))

defensive_stats <- prev_data %>%
  filter(!is.na(defteam), play_type %in% c("pass", "run")) %>%
  group_by(defteam) %>%
  summarize(
    prev_stop_rate_overall = mean(!first_down, na.rm = TRUE),
    prev_stop_rate_run = mean(!first_down[play_type == "run"], na.rm = TRUE),
    prev_stop_rate_pass = mean(!first_down[play_type == "pass"], na.rm = TRUE),
    prev_stop_rate_1st = mean(!first_down[down == 1], na.rm = TRUE),
    prev_stop_rate_2nd = mean(!first_down[down == 2], na.rm = TRUE),
    prev_stop_rate_3rd = mean(!first_down[down == 3], na.rm = TRUE),
    prev_stop_rate_4th = mean(!first_down[down == 4], na.rm = TRUE)
  )

message("\nDEBUG: Coverage Rate Calculation Check")
coverage_check <- prev_data %>%
  filter(!is.na(defteam), !is.na(defense_coverage_type)) %>%
  group_by(defteam, defense_coverage_type) %>%
  summarize(
    total_plays = n(),
    stops = sum(!first_down, na.rm = TRUE),
    stop_rate = mean(!first_down, na.rm = TRUE),
    .groups = 'drop'
  )
message("Sample coverage rates:")
print(head(coverage_check))

coverage_stats <- prev_data %>%
  filter(!is.na(defteam), !is.na(defense_coverage_type), 
         play_type %in% c("pass", "run")) %>%
  group_by(defteam, defense_coverage_type) %>%
  summarize(
    prev_coverage_plays = n(),
    prev_coverage_stop_rate = mean(!first_down, na.rm = TRUE),
    prev_coverage_stop_rate_run = mean(!first_down[play_type == "run"], na.rm = TRUE),
    prev_coverage_stop_rate_pass = mean(!first_down[play_type == "pass"], na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  group_by(defteam) %>%
  mutate(prev_coverage_usage_rate = prev_coverage_plays / sum(prev_coverage_plays)) %>%
  ungroup()

message("\nDEBUG: Run/Pass Tendency Check")
tendency_check <- prev_data %>%
  filter(play_type %in% c("pass", "run")) %>%
  group_by(posteam, down) %>%
  summarize(
    total_plays = n(),
    run_plays = sum(play_type == "run", na.rm = TRUE),
    run_pct = mean(play_type == "run", na.rm = TRUE),
    .groups = 'drop'
  )
message("Sample run/pass tendencies:")
print(head(tendency_check))

run_pass_tendencies <- prev_data %>%
  filter(play_type %in% c("pass", "run")) %>%
  group_by(posteam, down) %>%
  summarize(
    prev_down_plays = n(),
    prev_down_run_pct = mean(play_type == "run", na.rm = TRUE),
    .groups = 'drop'
  )

message("\nDEBUG: Fourth Down Run Tendency Check")
fourth_check <- prev_data %>%
  filter(down == 4, play_type %in% c("pass", "run")) %>%
  group_by(posteam) %>%
  summarize(
    total_attempts = n(),
    run_attempts = sum(play_type == "run", na.rm = TRUE),
    run_pct = mean(play_type == "run", na.rm = TRUE),
    .groups = 'drop'
  )
message("Sample fourth down tendencies:")
print(head(fourth_check))

fourth_down_tendencies <- prev_data %>%
  filter(down == 4, play_type %in% c("pass", "run")) %>%
  group_by(posteam) %>%
  summarize(
    prev_fourth_down_attempts = n(),
    prev_fourth_down_run_pct = mean(play_type == "run", na.rm = TRUE)
  )

message("\nDEBUG: Win Percentage Calculation Check")
win_check <- prev_data %>%
  select(game_id, posteam, defteam, posteam_score, defteam_score) %>%
  distinct() %>%
  mutate(won_game = posteam_score > defteam_score) %>%
  group_by(posteam) %>%
  summarize(
    games = n(),
    wins = sum(won_game, na.rm = TRUE),
    win_pct = mean(won_game, na.rm = TRUE)
  )
message("Sample win percentages:")
print(head(win_check))

team_stats <- prev_data %>%
  select(game_id, posteam, defteam, home_team, away_team, posteam_score, defteam_score) %>%
  distinct() %>%
  mutate(
    is_home = posteam == home_team,
    won_game = posteam_score > defteam_score
  ) %>%
  group_by(posteam) %>%
  summarize(
    prev_total_games = n(),
    prev_total_wins = sum(won_game, na.rm = TRUE),
    prev_win_pct = mean(won_game, na.rm = TRUE),
    prev_home_win_pct = mean(won_game[is_home], na.rm = TRUE),
    prev_away_win_pct = mean(won_game[!is_home], na.rm = TRUE)
  )

# Create defteam and down for both datasets
message("\nDEBUG: Adding required columns")
if(!"defteam" %in% names(third_downs)) {
  message("Adding defteam to third_downs")
  third_downs <- third_downs %>%
    mutate(defteam = case_when(
      posteam == home_team ~ away_team,
      posteam == away_team ~ home_team,
      TRUE ~ NA_character_
    ))
}

if(!"defteam" %in% names(fourth_downs)) {
  message("Adding defteam to fourth_downs")
  fourth_downs <- fourth_downs %>%
    mutate(defteam = case_when(
      posteam == home_team ~ away_team,
      posteam == away_team ~ home_team,
      TRUE ~ NA_character_
    ))
}

# Add down columns if not present
third_downs <- third_downs %>% mutate(down = 3)
fourth_downs <- fourth_downs %>% mutate(down = 4)

# Join stats to third downs with debugging
message("\nDEBUG: Third downs joins")
third_downs <- tryCatch({
  result <- third_downs %>%
    left_join(formation_stats, by = "posteam") %>%
    left_join(defensive_stats, by = "defteam") %>%
    left_join(coverage_stats, by = c("defteam", "defense_coverage_type")) %>%
    left_join(run_pass_tendencies, by = c("posteam", "down")) %>%
    left_join(fourth_down_tendencies, by = "posteam") %>%
    left_join(team_stats, by = "posteam")
  
  message("Third downs joins completed with columns:")
  message(paste(names(result), collapse=", "))
  result
}, error = function(e) {
  message("Error in third downs joins: ", e$message)
  return(third_downs)
})

# Join stats to fourth downs with debugging
message("\nDEBUG: Fourth downs joins")
fourth_downs <- tryCatch({
  result <- fourth_downs %>%
    left_join(formation_stats, by = "posteam") %>%
    {
      message("Formation stats joined")
      .
    } %>%
    left_join(defensive_stats, by = "defteam") %>%
    {
      message("Defensive stats joined")
      .
    } %>%
    left_join(coverage_stats, by = c("defteam", "defense_coverage_type")) %>%
    {
      message("Coverage stats joined")
      .
    } %>%
    left_join(run_pass_tendencies, by = c("posteam", "down")) %>%
    {
      message("Run/pass tendencies joined")
      .
    } %>%
    left_join(fourth_down_tendencies, by = "posteam") %>%
    {
      message("Fourth down tendencies joined")
      .
    } %>%
    left_join(team_stats, by = "posteam")
  
  message("Fourth downs joins completed with columns:")
  message(paste(names(result), collapse=", "))
  result
}, error = function(e) {
  message("Error in fourth downs joins: ", e$message)
  return(fourth_downs)
})

# Final validation
message("\nDEBUG: Final validation")
key_cols <- c(
  "prev_shotgun_rate",
  "prev_stop_rate_overall",
  "prev_coverage_stop_rate",
  "prev_win_pct",
  "prev_down_run_pct",
  "prev_fourth_down_run_pct"
)

message("\nChecking third_downs key columns:")
for(col in key_cols) {
  present <- col %in% names(third_downs)
  if(present) {
    na_count <- sum(is.na(third_downs[[col]]))
    message(sprintf("%s: Present with %d NA values", col, na_count))
  } else {
    message(sprintf("%s: Missing", col))
  }
}

message("\nChecking fourth_downs key columns:")
for(col in key_cols) {
  present <- col %in% names(fourth_downs)
  if(present) {
    na_count <- sum(is.na(fourth_downs[[col]]))
    message(sprintf("%s: Present with %d NA values", col, na_count))
  } else {
    message(sprintf("%s: Missing", col))
  }
}

message("\nFinal dimensions:")
message("Third downs: ", paste(dim(third_downs), collapse=" x "))
message("Fourth downs: ", paste(dim(fourth_downs), collapse=" x "))

message("Step 3.3 completed")

  message("Step 3.5/7: Assigning players to positions...")
  
  # Create empty player columns for third downs
  message("  Creating player columns for third downs...")
  for(i in 1:11) {
    third_downs[[paste0("offense_player_", i)]] <- NA_character_
    third_downs[[paste0("defense_player_", i)]] <- NA_character_
  }
  
  # Create empty player columns for fourth downs
  message("  Creating player columns for fourth downs...")
  for(i in 1:11) {
    fourth_downs[[paste0("offense_player_", i)]] <- NA_character_
    fourth_downs[[paste0("defense_player_", i)]] <- NA_character_
  }
  
# Updated position groupings with OTHER category
OFFENSE_POSITIONS <- list(
  ST = c("K", "P", "LS"),
  QB = "QB",
  BACKS = c("RB", "FB"),
  WR = "WR",
  TE = "TE", 
  OL = c("T", "G", "C", "OT", "OG"),
  OTHER = "OTHER"  # Catchall category
)

DEFENSE_POSITIONS <- list(
  ST = c("K", "P", "LS"),
  DL = c("DE", "DT", "NT", "DL"),
  LB = c("MLB", "ILB", "OLB", "LB"),
  DB = c("S", "FS", "SS", "SAF", "CB", "DB"),
  OTHER = "OTHER"  # Catchall category
)

assign_players_to_positions <- function(players_data, roster_data, is_offense = TRUE) {
  # Initialize empty slots
  player_slots <- rep(NA_character_, 11)
  next_slot <- 1
  
  # Skip if empty player data
  if(is.null(players_data) || players_data == "" || next_slot > 11) {
    return(player_slots)
  }
  
  # Get player ids from semicolon-separated string and count them
  player_ids <- unlist(strsplit(players_data, ";"))
  expected_players <- length(player_ids)
  
  if(expected_players == 0) {
    return(player_slots)
  }
  
  # Get player positions from roster data
  players_info <- roster_data %>%
    filter(gsis_id %in% player_ids) %>%
    select(gsis_id, depth_chart_position)
  
  if(nrow(players_info) == 0) {
    return(player_slots)
  }
  
  # Helper function to assign players of a position group
  assign_position_group <- function(position_group) {
    players <- players_info %>%
      filter(depth_chart_position %in% position_group)
    
    if(nrow(players) > 0 && next_slot <= 11) {
      slots_to_fill <- min(nrow(players), 12 - next_slot)
      player_slots[next_slot:(next_slot + slots_to_fill - 1)] <<- players$gsis_id[1:slots_to_fill]
      next_slot <<- next_slot + slots_to_fill
    }
  }
  
  # First handle special teams players
  assign_position_group(c("K", "P", "LS"))
  
  # Process regular position groups
  position_groups <- if(is_offense) OFFENSE_POSITIONS else DEFENSE_POSITIONS
  for(group in position_groups[!names(position_groups) %in% c("OTHER", "ST")]) {
    if(next_slot <= 11) {
      assign_position_group(group)
    } else {
      break
    }
  }
  
  # Fill any remaining slots with unassigned player IDs
  if(next_slot <= 11) {
    # Get all player IDs that haven't been assigned yet
    assigned_ids <- player_slots[!is.na(player_slots)]
    unassigned_ids <- setdiff(player_ids, assigned_ids)
    
    if(length(unassigned_ids) > 0) {
      slots_left <- 12 - next_slot
      ids_to_add <- min(length(unassigned_ids), slots_left)
      player_slots[next_slot:(next_slot + ids_to_add - 1)] <- unassigned_ids[1:ids_to_add]
    }
  }
  
  # Verify we've used as many players as possible
  actual_players <- sum(!is.na(player_slots))
  if(actual_players < min(expected_players, 11)) {
    # If we have fewer players than expected and slots available,
    # fill remaining slots with any unused IDs
    unused_ids <- setdiff(player_ids, player_slots[!is.na(player_slots)])
    remaining_slots <- which(is.na(player_slots))
    
    if(length(unused_ids) > 0 && length(remaining_slots) > 0) {
      slots_to_fill <- min(length(unused_ids), length(remaining_slots))
      player_slots[remaining_slots[1:slots_to_fill]] <- unused_ids[1:slots_to_fill]
    }
  }
  
  return(player_slots)
}
  
  # Apply position assignments to third downs
  message("  Processing third downs...")
  for(i in 1:nrow(third_downs)) {
    if(i %% 1000 == 0) message("    Processing row ", i, " of ", nrow(third_downs))
    
    # Process offense
    if(!is.na(third_downs$offense_players[i])) {
      player_slots <- assign_players_to_positions(third_downs$offense_players[i], roster_data, TRUE)
      for(j in 1:11) {
        third_downs[[paste0("offense_player_", j)]][i] <- player_slots[j]
      }
    }
    
    # Process defense
    if(!is.na(third_downs$defense_players[i])) {
      player_slots <- assign_players_to_positions(third_downs$defense_players[i], roster_data, FALSE)
      for(j in 1:11) {
        third_downs[[paste0("defense_player_", j)]][i] <- player_slots[j]
      }
    }
  }
  
  # Apply position assignments to fourth downs
  message("  Processing fourth downs...")
  for(i in 1:nrow(fourth_downs)) {
    if(i %% 1000 == 0) message("    Processing row ", i, " of ", nrow(fourth_downs))
    
    # Process offense
    if(!is.na(fourth_downs$offense_players[i])) {
      player_slots <- assign_players_to_positions(fourth_downs$offense_players[i], roster_data, TRUE)
      for(j in 1:11) {
        fourth_downs[[paste0("offense_player_", j)]][i] <- player_slots[j]
      }
    }
    
    # Process defense
    if(!is.na(fourth_downs$defense_players[i])) {
      player_slots <- assign_players_to_positions(fourth_downs$defense_players[i], roster_data, FALSE)
      for(j in 1:11) {
        fourth_downs[[paste0("defense_player_", j)]][i] <- player_slots[j]
      }
    }
  }
  
  message("Step 3.7/7: Counting original and assigned players...")
  
  # For third downs
  message("  Processing third downs...")
  third_downs <- third_downs %>%
    mutate(
      original_offense_count = ifelse(is.na(offense_players) | offense_players == "", 
                                    0, 
                                    lengths(strsplit(offense_players, ";"))),
      original_defense_count = ifelse(is.na(defense_players) | defense_players == "", 
                                    0, 
                                    lengths(strsplit(defense_players, ";")))
    ) %>%
    rowwise() %>%
    mutate(
      assigned_offense_count = sum(!is.na(c_across(starts_with("offense_player_")))),
      assigned_defense_count = sum(!is.na(c_across(starts_with("defense_player_"))))
    ) %>%
    ungroup()
  
  # For fourth downs
  message("  Processing fourth downs...")
  fourth_downs <- fourth_downs %>%
    mutate(
      original_offense_count = ifelse(is.na(offense_players) | offense_players == "", 
                                    0, 
                                    lengths(strsplit(offense_players, ";"))),
      original_defense_count = ifelse(is.na(defense_players) | defense_players == "", 
                                    0, 
                                    lengths(strsplit(defense_players, ";")))
    ) %>%
    rowwise() %>%
    mutate(
      assigned_offense_count = sum(!is.na(c_across(starts_with("offense_player_")))),
      assigned_defense_count = sum(!is.na(c_across(starts_with("defense_player_"))))
    ) %>%
    ungroup()
  

  
  message("Step 4/7: Adding player information...")
  for(i in 1:11) {
    cat("\rProcessing player", i, "of 11")
    third_downs <- add_player_info(third_downs, 
                                  roster_data, 
                                  paste0("offense_player_", i), 
                                  paste0("offense_player_", i))
    fourth_downs <- add_player_info(fourth_downs, 
                                   roster_data, 
                                   paste0("offense_player_", i), 
                                   paste0("offense_player_", i))
    
    third_downs <- add_player_info(third_downs, 
                                  roster_data, 
                                  paste0("defense_player_", i), 
                                  paste0("defense_player_", i))
    fourth_downs <- add_player_info(fourth_downs, 
                                   roster_data, 
                                   paste0("defense_player_", i), 
                                   paste0("defense_player_", i))
  }
  
  message("Step 5/7: Processing team injury data...")
  # Convert injuries_data to a standard data frame first
  injuries_data <- as.data.frame(injuries_data)
  
  third_downs <- third_downs %>%
    mutate(defteam = ifelse(posteam == home_team, away_team, home_team)) %>%
    left_join(run_pcts %>% 
                mutate(join_week = week + 1) %>% 
                select(-week), 
              by = c("posteam", "week" = "join_week")) %>%
    left_join(prep_time_df %>% 
                select(posteam, game_date, prep_days),
              by = c("posteam", "game_date"))

  fourth_downs <- fourth_downs %>%
    mutate(defteam = ifelse(posteam == home_team, away_team, home_team)) %>%
    left_join(run_pcts %>% 
                mutate(join_week = week + 1) %>% 
                select(-week), 
              by = c("posteam", "week" = "join_week")) %>%
    left_join(prep_time_df %>% 
                select(posteam, game_date, prep_days),
              by = c("posteam", "game_date"))

  get_team_injury_counts <- function(team, game_date) {
    game_date <- as.Date(game_date)
    
    team_injuries <- injuries_data %>%
      filter(team == !!team) %>%
      mutate(
        injury_date = as.Date(date_modified),
        standard_injury = case_when(
          practice_primary_injury %in% top_injury_types ~ practice_primary_injury,
          TRUE ~ "Other"
        )
      )
    
    year_ago <- game_date - 365
    year_injuries <- team_injuries %>%
      filter(injury_date >= year_ago,
             injury_date < game_date) %>%
      count(standard_injury) %>%
      pivot_wider(
        names_from = standard_injury,
        names_prefix = "injury_count_year_",
        values_from = n,
        values_fill = 0
      )
    
    week_ago <- game_date - 7
    week_injuries <- team_injuries %>%
      filter(injury_date >= week_ago,
             injury_date < game_date) %>%
      count(standard_injury) %>%
      pivot_wider(
        names_from = standard_injury,
        names_prefix = "injury_count_week_",
        values_from = n,
        values_fill = 0
      )
      
    week_status <- team_injuries %>%
      filter(injury_date >= week_ago,
             injury_date < game_date) %>%
      summarise(
        week_questionable = sum(report_status == "Questionable", na.rm = TRUE),
        week_doubtful = sum(report_status == "Doubtful", na.rm = TRUE),
        week_out = sum(report_status == "Out", na.rm = TRUE),
        week_limited_practice = sum(practice_status == "Limited Participation in Practice", na.rm = TRUE),
        week_dnp = sum(practice_status == "Did Not Participate In Practice", na.rm = TRUE)
      )
    
    bind_cols(year_injuries, week_injuries, week_status)
  }

  third_downs <- third_downs %>%
    rowwise() %>%
    mutate(
      offense_injuries = list(get_team_injury_counts(posteam, game_date)),
      defense_injuries = list(get_team_injury_counts(defteam, game_date))
    ) %>%
    ungroup() %>%
    unnest_wider(c(offense_injuries, defense_injuries), 
                 names_sep = "_")

  fourth_downs <- fourth_downs %>%
    rowwise() %>%
    mutate(
      offense_injuries = list(get_team_injury_counts(posteam, game_date)),
      defense_injuries = list(get_team_injury_counts(defteam, game_date))
    ) %>%
    ungroup() %>%
    unnest_wider(c(offense_injuries, defense_injuries), 
                 names_sep = "_")

  third_downs <- third_downs %>%
    group_by(posteam, game_date) %>%
    mutate(
      offense_avg_days_since_injury = mean(c_across(matches("offense_player_\\d+_days_since_injury")), na.rm = TRUE),
      offense_total_recent_injuries = sum(c_across(matches("offense_player_\\d+_injury_count_1yr")), na.rm = TRUE)
    ) %>%
    group_by(defteam, game_date) %>%
    mutate(
      defense_avg_days_since_injury = mean(c_across(matches("defense_player_\\d+_days_since_injury")), na.rm = TRUE),
      defense_total_recent_injuries = sum(c_across(matches("defense_player_\\d+_injury_count_1yr")), na.rm = TRUE)
    ) %>%
    ungroup()

  fourth_downs <- fourth_downs %>%
    group_by(posteam, game_date) %>%
    mutate(
      offense_avg_days_since_injury = mean(c_across(matches("offense_player_\\d+_days_since_injury")), na.rm = TRUE),
      offense_total_recent_injuries = sum(c_across(matches("offense_player_\\d+_injury_count_1yr")), na.rm = TRUE)
    ) %>%
    group_by(defteam, game_date) %>%
    mutate(
      defense_avg_days_since_injury = mean(c_across(matches("defense_player_\\d+_days_since_injury")), na.rm = TRUE),
      defense_total_recent_injuries = sum(c_across(matches("defense_player_\\d+_injury_count_1yr")), na.rm = TRUE)
    ) %>%
    ungroup()
  
  



# Add fixed down values since all third downs have down=3
third_downs$down <- 3
fourth_downs$down <- 4


  
message("Step 6: Checking key data structures and creating final models...")

# Print structure of all relevant datasets
message("\nData Structure Checks:")
message("\nthird_downs structure:")
print(str(third_downs))
message("\nfourth_downs structure:")
print(str(fourth_downs))
message("\ncoach_records structure:")
print(str(coach_records))
message("\ncurrent_team_records structure:")
print(str(current_team_records))
message("\ngame_tenure structure:")
print(str(game_tenure))
message("\nformation_tendencies structure:")
print(str(formation_tendencies))
message("\ndefense_tendencies structure:")
print(str(defense_tendencies))
message("\ncoverage_tendencies structure:")
print(str(coverage_tendencies))

# Debug data structures at start
message("\nChecking initial data structures...")
print(paste("play_year class:", paste(class(play_year), collapse = ", ")))
print(paste("third_downs rows:", nrow(third_downs)))
print(paste("fourth_downs rows:", nrow(fourth_downs)))

# Convert play_year to standard data frame if needed
play_year <- as.data.frame(play_year)
  
# Create the base models
message("\nCreating base models...")
model_3rd <- third_downs %>%
  mutate(
    play_type_clean = case_when(
      pass_attempt == 1 ~ "pass",
      rush_attempt == 1 ~ "rush",
      TRUE ~ "other"
    )
  ) %>%
  group_by(posteam) %>%
  arrange(week) %>%
  mutate(
    down1_pct = zoo::na.locf(down1_pct, na.rm = FALSE),
    down2_pct = zoo::na.locf(down2_pct, na.rm = FALSE),
    down3_pct = zoo::na.locf(down3_pct, na.rm = FALSE)
  ) %>%
  ungroup()

model_4th <- fourth_downs %>%
  mutate(
    play_type_clean = case_when(
      pass_attempt == 1 ~ "pass",
      rush_attempt == 1 ~ "rush",
      TRUE ~ "other"
    )
  ) %>%
  group_by(posteam) %>%
  arrange(week) %>%
  mutate(
    down1_pct = zoo::na.locf(down1_pct, na.rm = FALSE),
    down2_pct = zoo::na.locf(down2_pct, na.rm = FALSE),
    down3_pct = zoo::na.locf(down3_pct, na.rm = FALSE)
  ) %>%
  ungroup()

# Debug joins before processing
message("\nChecking pre-join data structures...")
print(paste("coach_records rows:", nrow(coach_records)))
print(paste("current_team_records rows:", nrow(current_team_records)))
print(paste("game_tenure rows:", nrow(game_tenure)))
print(paste("formation_tendencies rows:", nrow(formation_tendencies)))
print(paste("defense_tendencies rows:", nrow(defense_tendencies)))
print(paste("coverage_tendencies rows:", nrow(coverage_tendencies)))

# Process model_3rd joins
message("\nProcessing model_3rd joins...")
model_3rd <- tryCatch({
  temp_model <- model_3rd %>%
    left_join(coach_records, by = c("posteam_coach" = "coach"))
  message("Added coach_records")
  
  temp_model <- temp_model %>%
    left_join(current_team_records, by = c("posteam_coach" = "coach", "posteam"))
  message("Added current_team_records")
  
  temp_model <- temp_model %>%
    left_join(game_tenure %>% 
                select(game_id, posteam, coach, tenure_days), 
              by = c("game_id", "posteam", "posteam_coach" = "coach"))
  message("Added game_tenure")
  
  # Formation tendencies join
  temp_model <- temp_model %>%
    left_join(formation_tendencies %>% 
                filter(down == 3), 
              by = c("posteam", "down", "week"))
  message("Added formation_tendencies")
  
  # Defense tendencies join (now includes down-specific stats)
  temp_model <- temp_model %>%
    left_join(defense_tendencies,
              by = c("defteam", "week"))
  message("Added defense_tendencies with down-specific stats")
  
  # Coverage tendencies join
  temp_model <- temp_model %>%
    left_join(coverage_tendencies %>% 
                filter(down == 3), 
              by = c("defteam", "defense_coverage_type", "down", "week"))
  message("Added coverage_tendencies")
  
  temp_model
}, error = function(e) {
  message("Error in model_3rd joins: ", e$message)
  return(NULL)
})

message(paste("Final model_3rd rows:", nrow(model_3rd)))

# Process model_4th joins
message("\nProcessing model_4th joins...")
model_4th <- tryCatch({
  temp_model <- model_4th %>%
    left_join(coach_records, by = c("posteam_coach" = "coach"))
  message("Added coach_records")
  
  temp_model <- temp_model %>%
    left_join(current_team_records, by = c("posteam_coach" = "coach", "posteam"))
  message("Added current_team_records")
  
  temp_model <- temp_model %>%
    left_join(game_tenure %>% 
                select(game_id, posteam, coach, tenure_days), 
              by = c("game_id", "posteam", "posteam_coach" = "coach"))
  message("Added game_tenure")
  
  # Formation tendencies join
  temp_model <- temp_model %>%
    left_join(formation_tendencies %>% 
                filter(down == 4), 
              by = c("posteam", "down", "week"))
  message("Added formation_tendencies")
  
  # Defense tendencies join (now includes down-specific stats)
  temp_model <- temp_model %>%
    left_join(defense_tendencies,
              by = c("defteam", "week"))
  message("Added defense_tendencies with down-specific stats")
  
  # Coverage tendencies join
  temp_model <- temp_model %>%
    left_join(coverage_tendencies %>% 
                filter(down == 4), 
              by = c("defteam", "defense_coverage_type", "down", "week"))
  message("Added coverage_tendencies")
  
  temp_model
}, error = function(e) {
  message("Error in model_4th joins: ", e$message)
  return(NULL)
})

message(paste("Final model_4th rows:", nrow(model_4th)))

# Check for duplicates
message("\nChecking for duplicates...")
model_3rd_dupes <- model_3rd %>%
  group_by(play_id, game_id) %>%
  filter(n() > 1) %>%
  ungroup()

model_4th_dupes <- model_4th %>%
  group_by(play_id, game_id) %>%
  filter(n() > 1) %>%
  ungroup()

message("\nDuplicate summary:")
print(paste("model_3rd duplicates:", nrow(model_3rd_dupes)))
print(paste("model_4th duplicates:", nrow(model_4th_dupes)))

if(nrow(model_3rd_dupes) > 0 || nrow(model_4th_dupes) > 0) {
  message("\nSample of duplicates:")
  if(nrow(model_3rd_dupes) > 0) {
    print("Third down duplicates:")
    print(model_3rd_dupes %>% 
          select(play_id, game_id, posteam, defteam, offense_formation, defense_coverage_type) %>%
          head())
  }
  if(nrow(model_4th_dupes) > 0) {
    print("Fourth down duplicates:")
    print(model_4th_dupes %>% 
          select(play_id, game_id, posteam, defteam, offense_formation, defense_coverage_type) %>%
          head())
  }
}

# Final validation
message("\nFinal validation checks...")
print(paste("model_3rd columns:", ncol(model_3rd)))
print(paste("model_4th columns:", ncol(model_4th)))

# Check for key columns
key_columns <- c("play_id", "game_id", "posteam", "defteam", "play_type_clean")
missing_3rd <- key_columns[!key_columns %in% names(model_3rd)]
missing_4th <- key_columns[!key_columns %in% names(model_4th)]

if(length(missing_3rd) > 0) message("Missing columns in model_3rd: ", paste(missing_3rd, collapse=", "))
if(length(missing_4th) > 0) message("Missing columns in model_4th: ", paste(missing_4th, collapse=", "))

# Check for down-specific defensive metrics
defense_columns <- c(
  "def_stop_rate_run", "def_stop_rate_pass",
  "def_stop_rate_1st_run", "def_stop_rate_1st_pass",
  "def_stop_rate_2nd_run", "def_stop_rate_2nd_pass",
  "def_stop_rate_3rd_run", "def_stop_rate_3rd_pass",
  "def_stop_rate_4th_run", "def_stop_rate_4th_pass"
)

message("\nChecking defense-specific columns...")
defense_missing_3rd <- defense_columns[!defense_columns %in% names(model_3rd)]
defense_missing_4th <- defense_columns[!defense_columns %in% names(model_4th)]

if(length(defense_missing_3rd) > 0) {
  message("Missing defense columns in model_3rd: ", paste(defense_missing_3rd, collapse=", "))
}
if(length(defense_missing_4th) > 0) {
  message("Missing defense columns in model_4th: ", paste(defense_missing_4th, collapse=", "))
}

# Coverage validation
coverage_columns <- c(
  "defense_coverage_type",
  "coverage_stop_rate",
  "coverage_stop_rate_run",
  "coverage_stop_rate_pass"
)

message("\nChecking coverage columns...")
coverage_missing_3rd <- coverage_columns[!coverage_columns %in% names(model_3rd)]
coverage_missing_4th <- coverage_columns[!coverage_columns %in% names(model_4th)]

if(length(coverage_missing_3rd) > 0) {
  message("Missing coverage columns in model_3rd: ", paste(coverage_missing_3rd, collapse=", "))
}
if(length(coverage_missing_4th) > 0) {
  message("Missing coverage columns in model_4th: ", paste(coverage_missing_4th, collapse=", "))
}

# Return the final models
message("\nStep 6 completed successfully")
  
  message("Step 7/7: Adding specialists...")
  specialists <- get_specialists(year)

  specialists$kickers <- specialists$kickers %>%
    rename(
      kicker_id = kicker_player_id,
      kicker_name = kicker_player_name
    ) %>%
    filter(season == year | season == year - 1) %>%
    arrange(desc(season), desc(week)) %>%
    distinct(team, .keep_all = TRUE) %>%
    select(team, kicker_id, kicker_name)

  specialists$punters <- specialists$punters %>%
    rename(
      punter_id = punter_player_id,
      punter_name = punter_player_name
    ) %>%
    filter(season == year | season == year - 1) %>%
    arrange(desc(season), desc(week)) %>%
    distinct(team, .keep_all = TRUE) %>%
    select(team, punter_id, punter_name)

  model_4th <- model_4th %>%
    left_join(specialists$kickers, by = c("posteam" = "team")) %>%
    left_join(specialists$punters, by = c("posteam" = "team"))

  model_3rd <- model_3rd %>%
    left_join(specialists$kickers, by = c("posteam" = "team")) %>%
    left_join(specialists$punters, by = c("posteam" = "team"))

  return(list(
    third_downs = model_3rd,
    fourth_downs = model_4th
  ))
}
```


We need to modify the code to:

Handle the missing formation and coverage type columns in the previous year's data
Fix the coverage stop rate calculations to reduce NA values
Add proper fallback values when formation/coverage data isn't available

```{r}
# Main processing
years <- 2017:2023
all_data <- list()

for(year in years) {
  all_data[[as.character(year)]] <- process_year(year)
}

combined_third_downs <- bind_rows(
  lapply(all_data, function(x) validate_data(x$third_downs))
)

combined_fourth_downs <- bind_rows(
  lapply(all_data, function(x) validate_data(x$fourth_downs))
)
```


# filter out weeks with no info on who was on the field

get the rows in cfd and ctd that have a na in either offense_players or defense_players
```{r}
# Function to get max regular season week based on year
get_max_regular_season_week <- function(year) {
  if (year >= 2021) {
    return(18)  # 17-game season starting in 2021
  } else {
    return(17)  # 16-game season before 2021
  }
}

# Filter out playoff games from combined datasets
combined_third_downs <- combined_third_downs %>%
  filter(
    (season < 2021 & week <= 17) |  # Pre-2021 seasons
    (season >= 2021 & week <= 18)    # 2021 and later seasons
  )

combined_fourth_downs <- combined_fourth_downs %>%
  filter(
    (season < 2021 & week <= 17) |  # Pre-2021 seasons
    (season >= 2021 & week <= 18)    # 2021 and later seasons
  )

# Verify the filtering worked
print("Third downs week range by season:")
print(combined_third_downs %>% 
  group_by(season) %>% 
  summarise(min_week = min(week), max_week = max(week)))

print("\nFourth downs week range by season:")
print(combined_fourth_downs %>% 
  group_by(season) %>% 
  summarise(min_week = min(week), max_week = max(week)))
```



```{r}
# Get counts before filtering by season and week
before_counts_third <- combined_third_downs %>%
  group_by(season, week) %>%
  summarise(count_before = n())

before_counts_fourth <- combined_fourth_downs %>%
  group_by(season, week) %>%
  summarise(count_before = n())

# Filter and get counts after by season and week
after_counts_third <- combined_third_downs %>%
  filter(!is.na(offense_players) & !is.na(defense_players)) %>%
  group_by(season, week) %>%
  summarise(count_after = n())

after_counts_fourth <- combined_fourth_downs %>%
  filter(!is.na(offense_players) & !is.na(defense_players)) %>%
  group_by(season, week) %>%
  summarise(count_after = n())

# Compare before and after for third downs
lost_rows_third <- before_counts_third %>%
  left_join(after_counts_third, by = c("season", "week")) %>%
  mutate(rows_lost = count_before - count_after) %>%
  filter(rows_lost > 0) %>%
  arrange(season, week)

# Compare before and after for fourth downs
lost_rows_fourth <- before_counts_fourth %>%
  left_join(after_counts_fourth, by = c("season", "week")) %>%
  mutate(rows_lost = count_before - count_after) %>%
  filter(rows_lost > 0) %>%
  arrange(season, week)

# Print results
cat("Third Downs - Lost Rows by Season and Week:\n")
print(lost_rows_third)

cat("\nFourth Downs - Lost Rows by Season and Week:\n")
print(lost_rows_fourth)

# Print totals
cat("\nTotal rows removed from Third Downs:", sum(lost_rows_third$rows_lost))
cat("\nTotal rows removed from Fourth Downs:", sum(lost_rows_fourth$rows_lost))



# Filter out rows with missing player information
combined_third_downs <- combined_third_downs %>%
  filter(!is.na(offense_players) & !is.na(defense_players))

combined_fourth_downs <- combined_fourth_downs %>%
  filter(!is.na(offense_players) & !is.na(defense_players))
```




```{r}
# Read the attendance data
attendance_data <- read.csv("nfl_attendance_2016_2023.csv")
# Revised add_attendance function
add_attendance <- function(pbp_df, attendance_df) {
  pbp_df %>%
    left_join(
      # Reshape attendance data to long format for joining
      attendance_df %>%
        pivot_longer(
          cols = starts_with("Week."),  # Match Week. columns
          names_to = "week_label",
          values_to = "attendance"
        ) %>%
        # Extract week number, accounting for the dot
        mutate(
          week = as.numeric(gsub("Week\\.", "", week_label)),
          home_attendance = attendance
        ) %>%
        select(Team, Year, week, home_attendance),
      # Join conditions
      by = c(
        "home_team" = "Team",
        "season" = "Year",
        "week" = "week"
      )
    )
}

# Apply to your pbp datasets
combined_third_downs <- add_attendance(combined_third_downs, attendance_data)
combined_fourth_downs <- add_attendance(combined_fourth_downs, attendance_data)

# Verify the join worked
print("Number of NA attendance values in third downs:")
print(sum(is.na(combined_third_downs$home_attendance)))
print("\nNumber of NA attendance values in fourth downs:")
print(sum(is.na(combined_fourth_downs$home_attendance)))
```


```{r}
library(nflreadr)
library(tidyverse)
library(slider)

# Create season-aware team mapping function
team_name_mapping <- function(team, season) {
  case_when(
    # Chargers: SD -> LAC in 2017
    team == "LAC" & season < 2017 ~ "SD",
    team == "SD" & season >= 2017 ~ "LAC",
    # Rams: STL/SL -> LA in 2016
    team %in% c("LA", "SL") & season < 2016 ~ "STL",
    team == "STL" & season >= 2016 ~ "LA",
    # Raiders: OAK -> LV in 2020
    team == "LV" & season < 2020 ~ "OAK",
    team == "OAK" & season >= 2020 ~ "LV",
    # Other historical fixes
    team == "ARZ" ~ "ARI",
    team == "BLT" ~ "BAL",
    team == "CLV" ~ "CLE",
    team == "HST" ~ "HOU",
    # If no mapping needed, return original
    TRUE ~ team
  )
}

# Process roster data for team changes
player_team_changes <- load_rosters_weekly(seasons = 2015:2023) %>%
  filter(
    (season < 2021 & week <= 17) |  
    (season >= 2021 & week <= 18)    
  ) %>%
  mutate(
    team = map2_chr(team, season, team_name_mapping)
  ) %>%
  select(player_id = gsis_id, team, season, week) %>%
  group_by(player_id, season, week) %>%
  slice_tail(n = 1) %>%
  ungroup() %>%
  arrange(player_id, season, week) %>%
  group_by(player_id) %>%
  mutate(
    prev_team = lag(team),
    prev_season = lag(season),
    prev_week = lag(week)
  ) %>%
  filter(team != prev_team, !is.na(prev_team)) %>%
  # Remove relocations
  filter(!(
    # Rams relocation
    (prev_team == "STL" & team == "LA" & prev_season == 2015 & season == 2016) |
    # Chargers relocation
    (prev_team == "SD" & team == "LAC" & prev_season == 2016 & season == 2017) |
    # Raiders relocation
    (prev_team == "OAK" & team == "LV" & prev_season == 2019 & season == 2020)
  )) %>%
  select(
    player_id,
    season_from = prev_season,
    week_from = prev_week,
    season_to = season,
    week_to = week,
    old_team = prev_team,
    new_team = team
  ) %>%
  ungroup()

# Load and process games data
games_data <- load_schedules(seasons = 2013:2023) %>%
  filter(game_type == "REG") %>%
  mutate(
    home_team = map2_chr(home_team, season, team_name_mapping),
    away_team = map2_chr(away_team, season, team_name_mapping)
  )

# Create team-level data with wins
team_games <- bind_rows(
  # Home games
  games_data %>%
    select(season, week, team = home_team, opponent = away_team, 
           team_score = home_score, opp_score = away_score) %>%
    mutate(win = case_when(
      team_score > opp_score ~ 1,
      team_score < opp_score ~ 0,
      TRUE ~ 0.5  # ties count as half win
    )),
  # Away games  
  games_data %>%
    select(season, week, team = away_team, opponent = home_team, 
           team_score = away_score, opp_score = home_score) %>%
    mutate(win = case_when(
      team_score > opp_score ~ 1,
      team_score < opp_score ~ 0,
      TRUE ~ 0.5
    ))
) %>%
  arrange(season, week, team)

# Calculate rolling wins for each team
team_rolling_wins <- team_games %>%
  group_by(team) %>%
  arrange(season, week) %>%
  mutate(
    wins_last_18 = slide_sum(win, before = 17, after = 0)
  ) %>%
  ungroup()

# Final join
player_team_changes_with_wins <- player_team_changes %>%
  left_join(
    team_rolling_wins %>% 
      select(season, week, team, wins_last_18),
    by = c(
      "season_from" = "season",
      "week_from" = "week",
      "old_team" = "team"
    )
  ) %>%
  # Optionally rename the wins column to be more descriptive
  rename(old_team_wins_last_18 = wins_last_18)
```

```{r}
library(zoo)
# Create a complete season-week grid for each player
player_weeks <- load_rosters_weekly(seasons = 2015:2023) %>%
  select(player_id = gsis_id, season) %>%
  distinct() %>%
  # Create all possible weeks for each player-season
  crossing(
    week = 1:max(
      if_else(season < 2021, 17, 18)
    )
  ) %>%
  arrange(player_id, season, week)

# Join with roster data to get team information
player_status <- load_rosters_weekly(seasons = 2015:2023) %>%
  filter(
    (season < 2021 & week <= 17) |  
    (season >= 2021 & week <= 18)    
  ) %>%
  mutate(
    team = map2_chr(team, season, team_name_mapping)
  ) %>%
  select(player_id = gsis_id, team, season, week) %>%
  # Get latest team status for each week
  group_by(player_id, season, week) %>%
  slice_tail(n = 1) %>%
  ungroup() %>%
  right_join(player_weeks, by = c("player_id", "season", "week")) %>%
  arrange(player_id, season, week) %>%
  group_by(player_id) %>%
  # Fill in team status for weeks between changes
  fill(team, .direction = "down") %>%
  # Create sequential week number starting from 2015
  mutate(
    sequential_week = case_when(
      season == 2015 ~ week,
      season == 2016 ~ week + 17,
      season == 2017 ~ week + 34,
      season == 2018 ~ week + 51,
      season == 2019 ~ week + 68,
      season == 2020 ~ week + 85,
      season == 2021 ~ week + 102,
      season == 2022 ~ week + 120,
      season == 2023 ~ week + 138
    ),
    prev_team = lag(team),
    team_switch = team != prev_team & !is.na(prev_team),
    # Find the most recent switch week for each row
    last_switch_week = lag(if_else(team_switch, sequential_week, NA_real_)),
    last_switch_week = na.locf(last_switch_week, na.rm = FALSE),
    # Calculate weeks since most recent switch
    weeks_since_switch = if_else(
      is.na(last_switch_week),
      0,  # For players with no prior switches
      sequential_week - last_switch_week
    )
  ) %>%
  ungroup()

final_player_status <- player_status %>%
  # First join for current team wins
  left_join(
    team_rolling_wins %>% 
      select(season, week, team, wins_last_18),
    by = c("season", "week", "team")
  ) %>%
  group_by(player_id) %>%
  mutate(
    prev_team = lag(team),
    team_switch = team != prev_team & !is.na(prev_team),
    temp_old_team = if_else(team_switch, prev_team, NA_character_),
    old_team = na.locf(temp_old_team, na.rm = FALSE)
  ) %>%
  ungroup() %>%
  # Second join to get old team's wins
  left_join(
    team_rolling_wins %>% 
      select(season, week, team, wins_last_18),
    by = c("season" = "season", 
           "week" = "week",
           "old_team" = "team"),
    suffix = c("", "_old")
  ) %>%
  select(
    player_id,
    season,
    week,
    current_team = team,
    old_team,
    team_switch,
    weeks_since_switch,
    current_team_wins = wins_last_18,
    old_team_wins = wins_last_18_old
  )
```


```{r}
library(rlang)

add_switch_info <- function(pbp_data, switch_data) {
  # For each player column (offense 1-11, defense 1-11, kicker, punter)
  result <- pbp_data
  
  # Add kicker and punter info
  if("kicker_id" %in% names(result)) {
    result <- result %>%
      left_join(
        switch_data %>% 
          select(player_id, season, week, weeks_since_switch, old_team, old_team_wins),
        by = c("kicker_id" = "player_id", "season", "week"),
        suffix = c("", "_kicker")
      )
  }
  
  if("punter_id" %in% names(result)) {
    result <- result %>%
      left_join(
        switch_data %>% 
          select(player_id, season, week, weeks_since_switch, old_team, old_team_wins),
        by = c("punter_id" = "player_id", "season", "week"),
        suffix = c("", "_punter")
      )
  }
  
  # Process offensive players
  for(i in 1:11) {
    player_col <- paste0("offense_player_", i)
    join_by <- setNames(c("player_id", "season", "week"), c(player_col, "season", "week"))
    result <- result %>%
      left_join(
        switch_data %>% 
          select(player_id, season, week, weeks_since_switch, old_team, old_team_wins),
        by = join_by,
        suffix = c("", paste0("_o", i))
      )
  }
  
  # Process defensive players
  for(i in 1:11) {
    player_col <- paste0("defense_player_", i)
    join_by <- setNames(c("player_id", "season", "week"), c(player_col, "season", "week"))
    result <- result %>%
      left_join(
        switch_data %>% 
          select(player_id, season, week, weeks_since_switch, old_team, old_team_wins),
        by = join_by,
        suffix = c("", paste0("_d", i))
      )
  }
  
  return(result)
}

# Apply to both datasets
combined_third_downs<- add_switch_info(combined_third_downs, final_player_status)
combined_fourth_downs <- add_switch_info(combined_fourth_downs, final_player_status)
```

```{r}
#kill yards_gained
combined_third_downs <- combined_third_downs %>%
  select(-yards_gained)
combined_fourth_downs <- combined_fourth_downs %>%
  select(-yards_gained)
```

```{r}
# Function to add years since rookie for all players
add_yrs_since_rookie <- function(df) {
  # For each player 1-11
  for(i in 1:11) {
    # Offense players
    off_rookie_col <- paste0("offense_player_", i, "_rookie_year")
    off_yrs_since_col <- paste0("offense_player_", i, "_yrs_since_rookie")
    
    # Create new column with years since rookie
    df[[off_yrs_since_col]] <- df$season - df[[off_rookie_col]]
    
    # Defense players
    def_rookie_col <- paste0("defense_player_", i, "_rookie_year")
    def_yrs_since_col <- paste0("defense_player_", i, "_yrs_since_rookie")
    
    # Create new column with years since rookie
    df[[def_yrs_since_col]] <- df$season - df[[def_rookie_col]]
  }
  
  return(df)
}

# Apply to both datasets
combined_third_downs <- add_yrs_since_rookie(combined_third_downs)
combined_fourth_downs <- add_yrs_since_rookie(combined_fourth_downs)
```


```{r}
# Save results
write.csv(combined_third_downs, "ctd2.csv", row.names = FALSE)
write.csv(combined_fourth_downs, "cfd2.csv", row.names = FALSE)
```




```{r}
library(readr)
library(dplyr)
combined_third_downs <- read.csv("ctd.csv")
combined_fourth_downs <- read.csv("cfd.csv")
```



# Filtering for only 4th down attempts that are a rush_attempt = 1 or pass_attempt = 1
```{r}
attempts_4th <- combined_fourth_downs %>%
  filter(rush_attempt == 1 | pass_attempt == 1)
```

```{r}
# Define defensive positions
defensive_positions <- c("K", "P", "LS", "DB", "CB", "S", "FS", "SS", "LB", "ILB", "OLB", "MLB", "DL", "DE", "DT", "NT", "EDGE")

# Function to check if any offensive player has a defensive position
check_defensive_positions <- function(row) {
  # Get all offensive player positions
  positions <- c()
  for(i in 1:11) {
    pos_col <- paste0("offense_player_", i, "_position")
    if(pos_col %in% names(row)) {
      positions <- c(positions, row[[pos_col]])
    }
  }
  
  # Return TRUE if no defensive positions found
  !any(positions %in% defensive_positions, na.rm = TRUE)
}

# Apply the filter
clean_attempts_4th <- attempts_4th %>%
  filter(mapply(check_defensive_positions, split(., 1:nrow(.))))

# Print the number of rows removed
cat("Original rows:", nrow(attempts_4th), "\n")
cat("Rows after filtering:", nrow(clean_attempts_4th), "\n")
cat("Rows removed:", nrow(attempts_4th) - nrow(clean_attempts_4th), "\n")

# Optional: Examine some examples of removed plays
removed_plays <- attempts_4th %>%
  filter(!mapply(check_defensive_positions, split(., 1:nrow(.)))) %>%
  select(play_id, game_id, desc, matches("offense_player_\\d+_position"))

# Show first few removed plays
head(removed_plays)
```


check in the desc column if the word put or field goal insensitive to caps is present then kill it

```{r}
# Filter out plays with "punt" or "field goal" in the description
clean_attempts_4th <- clean_attempts_4th %>%
  filter(!grepl("punt", desc, ignore.case = TRUE) & !grepl("field goal", desc, ignore.case = TRUE))
```

write to cafd
```{r}
write.csv(clean_attempts_4th, "cafd2.csv", row.names = FALSE)
```


# the gsis id problem

get the players and k and p gsis ids then the offense and defense id cols so 26 cols in total into there own df with desc so 27 cols.. we will use 3rd down for just now

```{r}
# Read the combined third downs data
combined_third_downs <- read.csv("ctd.csv")

# Create vector of column names we want to keep
id_columns <- c(
  "game_id",
  "desc",
  "offense_players",
  "defense_players",
  "kicker_id",
  "punter_id",
  paste0("offense_player_", 1:11),
  paste0("defense_player_", 1:11)
)

# Create the check_ids dataframe
check_ids <- combined_third_downs[, id_columns]

# Print some summary information
cat("Dimensions of check_ids:", dim(check_ids), "\n")
cat("Column names:", colnames(check_ids), "\n")

# Check for NA values in each column
na_counts <- sapply(check_ids, function(x) sum(is.na(x)))
print("NA counts per column:")
print(na_counts)
```


now count how many values offense_players and defense_players have in them

```{r}
str(check_ids)
```


```{r}
check_ids <- check_ids %>%
  mutate(
    off_count = sapply(strsplit(offense_players, ";"), length),
    def_count = sapply(strsplit(defense_players, ";"), length)
  )
```

the 12s on def are heavily carolina

THE TUSH PUSH EAGLES NEED TO DIE




